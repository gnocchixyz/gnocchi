language: python
sudo: required

services:
  - docker

cache:
  directories:
    - ~/.cache/pip
env:
  - TARGET: bashate
  - TARGET: pep8
  - TARGET: docs
  - TARGET: docs-gnocchi.xyz

  - TARGET: py27-mysql-ceph-upgrade-from-3.1
  - TARGET: py35-postgresql-file-upgrade-from-3.1

  - TARGET: py27-mysql
  - TARGET: py35-mysql
  - TARGET: py36-mysql
  - TARGET: py27-postgresql
  - TARGET: py35-postgresql
  - TARGET: py36-postgresql

before_script:
  # Travis We need to fetch all tags/branches for documentation target
  - case $TARGET in
      docs*)
        git config --add remote.origin.fetch +refs/heads/stable/*:refs/remotes/origin/stable/*;
        git fetch --unshallow --tags;
        ;;
    esac
  - 'if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then git pull --rebase ; fi'
  - docker build --tag gnocchi-ci --file=tools/travis-ci-setup.dockerfile .
script:
  - docker run -v ~/.cache/pip:/home/tester/.cache/pip -v $(pwd):/home/tester/src gnocchi-ci tox -e ${TARGET}

notifications:
  email: false
  irc:
    on_success: change
    on_failure: always
    skip_join: true
    channels:
      - "irc.freenode.org#gnocchi"
