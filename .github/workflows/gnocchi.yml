name: Gnocchi

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug'
        required: false
        default: false
        type: boolean
  pull_request:

# NOTE(tobias-urdin): If you change any jobs make sure to modify
# the Mergify.io config in .mergify.yml to include the jobs!

jobs:
  doc:
    if: ${{ false }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        env:
          - docs
          - docs-gnocchi-web
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - run: sudo chown -R 1001:1001 $GITHUB_WORKSPACE
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            ci_image:
              - 'images/Dockerfile.ci'
              - 'images/entrypoint.sh.ci'
      - uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: steps.changes.outputs.ci_image == 'false'
      - run: docker pull ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'false'
      - uses: docker/build-push-action@v2
        with:
          context: ./images
          file: ./images/Dockerfile.ci
          push: false
          tags: ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'true'
      - name: Set env vars
        run: |
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "DOCKER_ENV_OPTS=-e GNOCCHI_TEST_DEBUG=1" >> $GITHUB_ENV
          else
            echo "DOCKER_ENV_OPTS=" >> $GITHUB_ENV
          fi
      - name: Run tests with tox in container
        run: docker run --rm -v ${{ github.workspace }}:/github/workspace -w /github/workspace $DOCKER_ENV_OPTS ghcr.io/gnocchixyz/ci:latest "tox -e ${{ matrix.env }}"

  check:
    if: ${{ false }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        env:
          - build
          - pep8
    steps:
      - uses: actions/checkout@v2
      - run: sudo chown -R 1001:1001 $GITHUB_WORKSPACE
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            ci_image:
              - 'images/Dockerfile.ci'
              - 'images/entrypoint.sh.ci'
      - uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: steps.changes.outputs.ci_image == 'false'
      - run: docker pull ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'false'
      - uses: docker/build-push-action@v2
        with:
          context: ./images
          file: ./images/Dockerfile.ci
          push: false
          tags: ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'true'
      - name: Set env vars
        run: |
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "DOCKER_ENV_OPTS=-e GNOCCHI_TEST_DEBUG=1" >> $GITHUB_ENV
          else
            echo "DOCKER_ENV_OPTS=" >> $GITHUB_ENV
          fi
      - name: Run tests with tox in container
        run: docker run --rm -v ${{ github.workspace }}:/github/workspace -w /github/workspace $DOCKER_ENV_OPTS ghcr.io/gnocchixyz/ci:latest "tox -e ${{ matrix.env }}"

  test-new:
    runs-on: ubuntu-20.04
    timeout-minutes: 30
    strategy:
      matrix:
        python-version:
          - 3.6
          - 3.8
          - 3.9
        indexer:
          - postgresql
          - mysql
        storage:
          - file
        coordinator:
          - redis
    steps:
      - uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Show python version
        run: python --version
      - name: Install tox
        run: pip install tox
      - uses: actions/checkout@v2
      - name: Set environment variables
        run: |
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "GNOCCHI_TEST_DEBUG=1" >> $GITHUB_ENV
          fi
          echo "GNOCCHI_TEST_INDEXER_DRIVER=${{ matrix.indexer }}" >> $GITHUB_ENV
          echo "GNOCCHI_TEST_STORAGE_DRIVER=${{ matrix.storage }}" >> $GITHUB_ENV
          echo "GNOCCHI_TEST_COORDINATOR_DRIVER=${{ matrix.coordinator }}" >> $GITHUB_ENV
      - name: Run test.sh
        run: ./test.sh

  test:
    if: ${{ false }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python:
          - py36
          - py38
          - py39
        env:
          - mysql-ceph-upgrade-from-4.4
          - postgresql-file-upgrade-from-4.4
          - mysql-file
          - mysql-swift
          - mysql-s3
          - mysql-ceph
          - postgresql-file
          - postgresql-swift
          - postgresql-s3
          - postgresql-ceph
        exclude:
          - env: mysql-ceph-upgrade-from-4.4
            python: py36
          - env: mysql-ceph
            python: py36
          - env: postgresql-ceph
            python: py36
          - env: mysql-ceph-upgrade-from-4.4
            python: py39
          - env: mysql-ceph
            python: py39
          - env: postgresql-ceph
            python: py39
    steps:
      - uses: actions/checkout@v2
      - run: sudo chown -R 1001:1001 $GITHUB_WORKSPACE
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            ci_image:
              - 'images/Dockerfile.ci'
              - 'images/entrypoint.sh.ci'
      - uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: steps.changes.outputs.ci_image == 'false'
      - run: docker pull ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'false'
      - uses: docker/build-push-action@v2
        with:
          context: ./images
          file: ./images/Dockerfile.ci
          push: false
          tags: ghcr.io/gnocchixyz/ci:latest
        if: steps.changes.outputs.ci_image == 'true'
      - name: Set env vars
        run: |
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "DOCKER_ENV_OPTS=-e GNOCCHI_TEST_DEBUG=1" >> $GITHUB_ENV
          else
            echo "DOCKER_ENV_OPTS=" >> $GITHUB_ENV
          fi
      - name: Run tests with tox in container
        run: docker run --rm -v ${{ github.workspace }}:/github/workspace -w /github/workspace $DOCKER_ENV_OPTS ghcr.io/gnocchixyz/ci:latest "tox -e ${{ matrix.python }}-${{ matrix.env }}"
